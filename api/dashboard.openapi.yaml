openapi: 3.0.3
info:
  title: CPU Simulation Dashboard API
  description: 管理面API，用于管理多个CPU仿真主机和全局实验
  version: 2.0.0
servers:
  - url: http://localhost:9090
    description: Dashboard server
security: []
paths:
  /api/experiments:
    get:
      summary: 获取实验列表
      operationId: getExperiments
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: 全局实验列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExperimentListResponse'

    post:
      summary: 创建实验
      operationId: createGlobalExperiment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateExperimentRequest'
      responses:
        '201':
          description: 实验创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Experiment'

  /api/experiments/{experimentId}:
    get:
      summary: 获取全局实验详情
      operationId: getGlobalExperiment
      parameters:
        - name: experimentId
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'
      responses:
        '200':
          description: 实验详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Experiment'

  /api/experiments/{experimentId}/stop:
    post:
      summary: 停止全局实验并收集数据
      description: 停止所有主机上的实验并自动收集数据到data目录
      operationId: stopGlobalExperiment
      parameters:
        - name: experimentId
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'
      responses:
        '200':
          description: 实验停止和数据收集结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StopAndCollectResponse'

  /api/experiments/{experimentId}/data:
    get:
      summary: 获取实验数据
      operationId: getExperimentData
      parameters:
        - name: experimentId
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'
        - name: hostName
          in: query
          required: false
          schema:
            type: string
          description: 指定主机名，不指定则返回所有主机数据概要
      responses:
        '200':
          description: 实验数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExperimentDataResponse'

  # ===== 主机管理 =====
  /api/hosts:
    get:
      summary: 获取所有主机列表
      operationId: getHosts
      responses:
        '200':
          description: 主机列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  hosts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Host'

  /api/hosts/{name}/health:
    get:
      summary: 检查主机健康状态
      operationId: getHostHealth
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 主机健康状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HostHealth'

  /api/hosts/{name}/calculate:
    post:
      summary: 测试主机CPU计算
      operationId: testHostCalculation
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculationRequest'
      responses:
        '200':
          description: 计算结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationResponse'


components:
  schemas:
    CreateExperimentRequest:
      type: object
      required:
        - experimentId
        - name
        - participatingHosts
      properties:
        experimentId:
          type: string
          pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'
          minLength: 1
          maxLength: 63
          description: 实验唯一标识
        description:
          type: string
          maxLength: 500
          description: 实验描述
        timeout:
          type: integer
          minimum: 60
          maximum: 3600
          default: 300
          description: 超时时间(秒)
        collectionInterval:
          type: integer
          minimum: 100
          maximum: 10000
          default: 1000
          description: 数据收集间隔(毫秒)
        participatingHosts:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - name
              - ip
            properties:
              name:
                type: string
                description: 主机名
              ip:
                type: string
                description: 主机IP地址

    Experiment:
      type: object
      required:
        - experimentId
        - createdAt
        - participatingHosts
      properties:
        experimentId:
          type: string
          pattern: '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'
        description:
          type: string
        createdAt:
          type: string
          format: date-time
        timeout:
          type: integer
        collectionInterval:
          type: integer
        participatingHosts:
          type: array
          items:
            type: object
            required:
              - name
              - ip
            properties:
              name:
                type: string
              ip:
                type: string

    ExperimentListResponse:
      type: object
      required:
        - experiments
        - total
      properties:
        experiments:
          type: array
          items:
            $ref: '#/components/schemas/Experiment'
        total:
          type: integer
        hasMore:
          type: boolean

    # ===== 复用collector API的数据结构 =====
    MetricDataPoint:
      type: object
      required:
        - timestamp
        - systemMetrics
      properties:
        timestamp:
          type: string
          format: date-time
        systemMetrics:
          type: object
          required:
            - cpuUsagePercent
            - memoryUsageBytes
            - memoryUsagePercent
            - networkIOBytes
            - calculatorServiceHealthy
          properties:
            cpuUsagePercent:
              type: number
              format: float
              minimum: 0
              maximum: 100
            memoryUsageBytes:
              type: integer
              format: int64
              minimum: 0
            memoryUsagePercent:
              type: number
              format: float
              minimum: 0
              maximum: 100
            networkIOBytes:
              type: object
              required:
                - bytesReceived
                - bytesSent
                - packetsReceived
                - packetsSent
              properties:
                bytesReceived:
                  type: integer
                  format: int64
                  minimum: 0
                bytesSent:
                  type: integer
                  format: int64
                  minimum: 0
                packetsReceived:
                  type: integer
                  format: int64
                  minimum: 0
                packetsSent:
                  type: integer
                  format: int64
                  minimum: 0
            calculatorServiceHealthy:
              type: boolean

    StopAndCollectResponse:
      type: object
      required:
        - experimentId
        - status
        - timestamp
      properties:
        experimentId:
          type: string
        status:
          type: string
          enum: [success, partial, failed]
          description: 停止和收集的总体状态
        timestamp:
          type: string
          format: date-time
        message:
          type: string
        hostsCollected:
          type: array
          description: 成功收集数据的主机列表
          items:
            type: object
            properties:
              name:
                type: string
              ip:
                type: string
        hostsFailed:
          type: array
          description: 收集失败的主机列表
          items:
            type: object
            properties:
              name:
                type: string
              ip:
                type: string
              error:
                type: string
                description: 失败原因

    ExperimentDataResponse:
      type: object
      required:
        - experimentId
      properties:
        experimentId:
          type: string
        experiment:
          $ref: '#/components/schemas/Experiment'
          description: 实验元信息存储在data目录下experimentId目录下的experiment.json文件中
        hosts:
          type: array
          description: 实验数据信息存储在data目录下experimentId目录下的data.json文件中，以hosts json列表形式存储
          items:
            type: object
            required:
              - name
              - ip
            properties:
              name:
                type: string
                description: 主机名
              ip:
                type: string
                description: 主机IP
              data:
                $ref: '#/components/schemas/CollectorExperimentData'
                description: 完整实验数据(仅在查询特定主机时返回)

    # 从collector API获取的实验数据结构
    CollectorExperimentData:
      type: object
      description: 与collector API的ExperimentData格式完全一致
      properties:
        experimentId:
          type: string
        description:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        duration:
          type: integer
          description: 实验时长(秒)
        collectionInterval:
          type: integer
          description: 数据收集间隔(毫秒)
        metrics:
          type: array
          items:
            $ref: '#/components/schemas/MetricDataPoint'

    Host:
      type: object
      properties:
        name:
          type: string
        ip:
          type: string
        cpuServiceUrl:
          type: string
        collectorServiceUrl:
          type: string

    HostHealth:
      type: object
      properties:
        name:
          type: string
        ip:
          type: string
        cpuServiceHealthy:
          type: boolean
        collectorServiceHealthy:
          type: boolean
        timestamp:
          type: string
          format: date-time

    CalculationRequest:
      type: object
      properties:
        a:
          type: integer
        b:
          type: integer

    CalculationResponse:
      type: object
      properties:
        gcd:
          type: string
        process_time:
          type: string

